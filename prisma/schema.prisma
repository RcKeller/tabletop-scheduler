generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MeetingType {
  DISCORD
  ZOOM
  GOOGLE_MEET
  ROLL20
  FOUNDRY_VTT
  IN_PERSON
  OTHER
}

enum CampaignType {
  ONESHOT
  CAMPAIGN
}

model GameSystem {
  id                  String   @id @default(uuid())
  name                String   @unique
  description         String?
  imageBase64         String?  @db.Text
  defaultInstructions String?  @db.Text
  defaultUrls         Json?    // Array of { label: string, url: string }
  isBuiltIn           Boolean  @default(false)
  createdAt           DateTime @default(now())
  events              Event[]

  @@map("game_systems")
}

model Event {
  id                String        @id @default(uuid())
  slug              String        @unique
  title             String
  description       String?
  timezone          String        @default("UTC")
  createdAt         DateTime      @default(now())
  participants      Participant[]

  // Campaign type (oneshot vs campaign)
  campaignType                   CampaignType @default(CAMPAIGN)

  // Game system relationship
  gameSystemId               String?
  gameSystem                 GameSystem? @relation(fields: [gameSystemId], references: [id], onDelete: SetNull)

  // Campaign configuration
  campaignImageBase64        String?     @db.Text
  sessionLengthMinutes       Int         @default(180)
  customPreSessionInstructions String?   @db.Text
  playerPrepUrls             Json?       // Array of { label: string, url: string }

  // Date range for availability window
  startDate                  DateTime?   @db.Date
  endDate                    DateTime?   @db.Date

  // Daily time window (stored in event timezone)
  earliestTime               String      @default("00:00")
  latestTime                 String      @default("23:30")

  // Meeting configuration
  meetingType                MeetingType?
  meetingLocation            String?
  meetingRoom                String?

  // Legacy fields (kept for backward compatibility)
  isRecurring                Boolean     @default(false)
  recurrencePattern          Json?
  startTime                  DateTime?
  durationMinutes            Int?

  @@map("events")
}

model Participant {
  id                    String                 @id @default(uuid())
  eventId               String
  event                 Event                  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  displayName           String
  isGm                  Boolean                @default(false)
  characterName         String?
  characterClass        String?
  characterSheetUrl     String?
  characterTokenBase64  String?                @db.Text
  notes                 String?                @db.VarChar(255)
  createdAt             DateTime               @default(now())
  availability          Availability[]
  generalAvailability   GeneralAvailability[]
  exceptions            AvailabilityException[]

  @@unique([eventId, displayName])
  @@map("participants")
}

model Availability {
  id            String      @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  date          DateTime    @db.Date
  startTime     String
  endTime       String

  @@unique([participantId, date, startTime, endTime])
  @@map("availability")
}

model GeneralAvailability {
  id            String      @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  dayOfWeek     Int
  startTime     String
  endTime       String

  @@unique([participantId, dayOfWeek, startTime, endTime])
  @@map("general_availability")
}

model AvailabilityException {
  id            String      @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  date          DateTime    @db.Date
  startTime     String
  endTime       String
  reason        String?

  @@unique([participantId, date, startTime, endTime])
  @@map("availability_exceptions")
}
